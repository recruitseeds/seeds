name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  NODE_VERSION: '20'

jobs:
  test:
    name: Lint, Type Check & Build
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: '**/package-lock.json'
    
    - name: Install root dependencies
      run: npm ci
      
    - name: Install dependencies
      run: |
        cd apps/web && npm ci
        cd ../api && npm ci
        cd ../jobs && npm ci
    
    - name: Lint check
      run: |
        cd apps/web && npm run lint
        cd ../api && npm run lint
        cd ../jobs && npm run lint
    
    - name: Type check
      run: |
        cd apps/web && npm run typecheck
        cd ../api && npm run typecheck
        cd ../jobs && npm run typecheck
    
    - name: Build artifacts
      run: |
        cd apps/web && npm run build
        cd ../api && npm run build
        cd ../jobs && npm run build

  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Deploy to droplet
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.DROPLET_HOST }}
        username: ${{ secrets.DROPLET_USER }}
        key: ${{ secrets.DROPLET_SSH_KEY }}
        port: 22
        command_timeout: 30m
        script: |
          cd /var/www/recruit-seeds
          
          echo "ğŸ”„ Pulling latest changes..."
          git fetch origin
          git reset --hard origin/main
          
          echo "ğŸ“¦ Installing dependencies..."
          npm ci
          cd apps/api && npm ci && cd ..
          cd apps/web && npm ci && cd ..
          cd apps/jobs && npm ci && cd ..
          
          echo "ğŸ—ï¸  Building applications..."
          cd apps/api && npm run build && cd ..
          cd apps/web && npm run build && cd ..
          cd apps/jobs && npm run build && cd ..
          
          echo "ğŸ”„ Restarting services..."
          sudo systemctl restart recruit-seeds-api
          sleep 5
          sudo systemctl restart recruit-seeds-web  
          sleep 5
          sudo systemctl restart recruit-seeds-jobs
          sleep 5
          
          echo "ğŸ©º Health checks..."
          if curl -f http://localhost:3001/api/v1/health > /dev/null 2>&1; then
            echo "âœ… API service healthy"
          else
            echo "âŒ API service health check failed"
            sudo systemctl status recruit-seeds-api
          fi
          
          if curl -f http://localhost:3000 > /dev/null 2>&1; then
            echo "âœ… Web service healthy"  
          else
            echo "âŒ Web service health check failed"
            sudo systemctl status recruit-seeds-web
          fi
          
          if curl -f http://localhost:3002 > /dev/null 2>&1; then
            echo "âœ… Jobs service healthy"
          else
            echo "âŒ Jobs service health check failed" 
            sudo systemctl status recruit-seeds-jobs
          fi
          
          echo "âœ… Deployment completed!"